#!/bin/bash

# Copyright 2020 Adevinta

nvm install 8 || nvm use --delete-prefix v8.12.0
npm install newman@4.1.0
node_modules/.bin/newman --version

docker run --name vulndbtest -d --rm -e POSTGRES_USER=vulndb -e POSTGRES_PASSWORD=vulndb -e POSTGRES_DB=vulndbtest -p 5440:5432 postgres:13.3-alpine

rm -rf /tmp/vulnerability-db
git clone --branch master git@github.com:adevinta/vulnerability-db.git /tmp/vulnerability-db

docker run --net=host -v /tmp/vulnerability-db/db:/flyway/sql flyway/flyway:"${FLYWAY_VERSION:-8}-alpine" \
    -user=vulndb -password=vulndb -url=jdbc:postgresql://localhost:5440/vulndbtest -baselineOnMigrate=true migrate

TestDBPort=5440 go run fixtures.go ../_resources/e2e/fixtures/

cd .. && go install ./... && cd -
vulnerability-db-api -c ../_resources/config/local-e2e.toml &

node_modules/.bin/newman run ../_resources/e2e/postman/Vulnerability_DB_API.postman_collection.json -r cli,junit --reporter-junit-export build/reports/tests/newman.xml

rm -rf build/
rm -rf package-lock.json 
rm -rf node_modules/
rm -rf /tmp/vulnerability-db/
docker stop vulndbtest
pkill vulnerability-db-api
