/*
Copyright 2020 Adevinta
*/

CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE targets (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
    identifier TEXT NOT NULL,
    type TEXT NOT NULL,
    UNIQUE (identifier, type)
);

CREATE TABLE sources (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    component TEXT NOT NULL,
    instance TEXT NOT NULL,
    options TEXT NOT NULL,
    UNIQUE (name, component, instance, options)
);

CREATE TABLE issues (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
    summary TEXT NOT NULL,
    score REAL,
    cwe_id INT NOT NULL,
    description TEXT NOT NULL,
    recommendations TEXT[] NOT NULL,
    reference_links TEXT[] NOT NULL,
    UNIQUE(summary, description)
);

CREATE TABLE findings (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
    issue_id TEXT REFERENCES issues(id),
    target_id TEXT REFERENCES targets(id),
    status TEXT NOT NULL,
    details  TEXT NOT NULL,
    resources TEXT[] NOT NULL,
    attachments TEXT[] NOT NULL,
    UNIQUE (issue_id, target_id)
);

CREATE TABLE finding_events (
    finding_id TEXT REFERENCES findings(id),
    source_id TEXT REFERENCES sources(id),
    time timestamp DEFAULT NOW(),
    PRIMARY KEY (finding_id, source_id, time)
);

CREATE TABLE source_issues (
    source_id TEXT REFERENCES sources(id),
    issue_id TEXT REFERENCES issues(id),
    PRIMARY KEY (source_id, issue_id)
);
