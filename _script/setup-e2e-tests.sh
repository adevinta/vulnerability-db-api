#!/bin/bash

# Copyright 2021 Adevinta

set -e

# Setup the test database
psql -c "CREATE DATABASE vulndbtest;" -U postgres
psql -c "CREATE USER vulndb WITH PASSWORD 'vulndb';" -U postgres
psql -c "ALTER USER vulndb WITH SUPERUSER;" -U postgres

# Install Newman, the CLI for Postman collections
nvm install 8 || nvm use --delete-prefix v8.12.0
npm install newman@4.1.0
node_modules/.bin/newman --version

# Obtain a copy of the Vulnerability DB consumer source code. 
# It contains the actual schema for the vulnerabiltiy-db-api.
git clone https://github.com/adevinta/vulnerability-db.git /tmp/vulnerability-db

# Run the migrations on the test database
docker run --net="host" -v /tmp/vulnerability-db/db:/scripts boxfuse/flyway -user=vulndb -password=vulndb -url=jdbc:postgresql://localhost:5432/vulndbtest -baselineOnMigrate=true -locations=filesystem:/scripts/sql migrate

# Load fixtures in the test database
go run e2e/fixtures.go _resources/e2e/fixtures/
