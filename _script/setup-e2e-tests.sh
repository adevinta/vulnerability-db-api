#!/bin/bash

# Copyright 2020 Adevinta

set -e

# Install Newman, the CLI for Postman collections
nvm install 8 || nvm use --delete-prefix v8.12.0
npm install newman@4.1.0
node_modules/.bin/newman --version

# Obtain a copy of the Vulnerability DB consumer source code. 
# It contains the actual schema for the vulnerabiltiy-db-api.
git clone --single-branch --branch master https://github.com/adevinta/vulnerability-db.git /tmp/vulnerability-db

# Run the migrations on the test database
docker run --net=host --rm -v /tmp/vulnerability-db/db/sql:/flyway/sql flyway/flyway:"${FLYWAY_VERSION:-8}-alpine" \
    -user=vulndb -password=vulndb -url=jdbc:postgresql://localhost:5432/vulndbtest -baselineOnMigrate=true migrate

# Load fixtures in the test database
go run e2e/fixtures.go _resources/e2e/fixtures/
