#!/bin/sh

# Copyright 2020 Adevinta

# Set default values for optional env vars.
export PG_HOST_READ=${PG_HOST_READ:-""}
export PG_PORT_READ=${PG_PORT_READ:-""}
export PG_USER_READ=${PG_USER_READ:-""}
export PG_PASSWORD_READ=${PG_PASSWORD_READ:-""}
export PG_NAME_READ=${PG_NAME_READ:-""}
export PG_SSLMODE_READ=${PG_SSLMODE_READ:-""}

# Apply env variables
envsubst < config.toml > run.toml

if [ -n "$PG_CA_B64" ]; then
  mkdir /root/.postgresql
  echo $PG_CA_B64 | base64 -d > /root/.postgresql/root.crt   # for flyway
  echo $PG_CA_B64 | base64 -d > /etc/ssl/certs/pg.crt  # for vulcan-api
fi

exec ./vulnerability-db-api -c run.toml
